<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pagina Iniziale - BTF</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="main.js" defer></script> 
  <link rel="icon" type="image/x-icon" href="/btf-databytes/icone/logo/btf.png">
</head>
<body>
  <header>
    <div class="header-left">
      <div class="logo">
        <img src="/btf-databytes/icone/logo/btf.png" alt="BTF Logo" />
      </div>
      <div class="header-buttons">
        <a href="index.html" class="btn btn-orange btn-small active">Pagina iniziale</a>
        <a href="attivita.html" class="btn btn-orange btn-small">Attività di raccolta</a>
        <a href="confronto.html" class="btn btn-orange btn-small">Confronto dati</a>
      </div>
    </div>
  </header>

  <div class="filters">
    <label for="regionSelect">Regione:</label>
    <select id="regionSelect" title="Seleziona Regione">
      <option></option>
      <option>Trentino</option>
      <option>Veneto</option>
      <option>Piemonte</option>
    </select>

    <label for="zoneSelect">Zona:</label>
    <select id="zoneSelect">
      <option></option>
      <option>Zona 1</option>
      <option>Zona 2</option>
      <option>Zona 3</option>
    </select>

    <label for="nodeSelect">Nodo:</label>
    <select id="nodeSelect">
      <option></option>
      <option>Ristorazione</option>
      <option>Supermercati</option>
      <option>Mense scolastiche</option>
    </select>

    <label for="mensaSelect">Mensa:</label>
    <select id="mensaSelect">
      <option value=""></option>
      <option value="Povo_1">Povo 1</option>
      <option value="Povo_2">Povo 2</option>
      <option value="BLM-ADIGE_SALA">BLM-ADIGE_SALA</option>
    </select>

    <label for="timeframeStart">Da:</label>
    <input type="date" id="timeframeStart">

    <label for="timeframeEnd">A:</label>
    <input type="date" id="timeframeEnd">

    <a href="#myChart" class="apply-filters" id="applyFiltersBtn">Applica filtri</a>

  <main>
    <section class="map-and-stats">
      <div class="map-container">
        <img src="/btf-databytes/ita-scale-true.png" usemap="#italy-map" alt="Mappa d'Italia" width="474">
        <map name="italy-map">
          <area shape="poly"
                coords="157,20,155,29,156,36,160,42,155,45,159,50,158,57,154,61,158,67,166,75,173,79,180,78,184,72,189,67,197,69,198,61,204,56,207,49,206,41,209,34,214,32,220,31,222,23,217,16,217,9,211,8,205,15,196,13,189,13,180,19,171,23,164,19"
                alt="Trentino"
                title="Trentino"
                href="trentino.html">
          <area target="" alt="Veneto" title="Veneto" href="veneto.html" coords="225,29,232,30,237,33,230,39,226,43,222,49,223,57,224,63,224,68,228,73,235,76,240,72,245,76,247,82,236,90,229,88,225,93,218,95,217,106,221,109,224,114,227,118,216,116,210,120,203,118,198,122,192,121,185,117,179,114,174,110,170,106,164,101,160,94,161,87,164,80,171,78,178,80,186,72,193,67,199,66,197,57,205,55,207,48,207,41,211,35,219,34" shape="poly">
          <area target="" alt="Lombardia" title="Lombardia" href="lombardia.html" coords="117,36,119,42,124,47,130,48,132,42,139,44,141,50,146,54,144,40,144,33,146,27,151,34,158,40,156,49,155,56,156,66,157,72,166,75,164,82,162,88,162,95,164,101,170,106,175,110,182,114,186,119,176,119,168,120,162,116,156,120,150,119,145,114,135,111,129,112,123,108,118,110,113,111,110,116,111,121,109,126,103,121,94,114,89,111,86,105,85,99,90,97,96,93,94,86,92,79,91,72,91,65,94,59,98,64,102,69,108,70,106,62,106,56,114,49" shape="poly">
        </map>
      </div>
      <div class="stat-grid">
        <!-- Box CO2 -->
        <div class="stat-box box-green">
          <div class="box-title">
            <img src="/btf-databytes/icone/Ai/co2.png" alt="Icona CO2" class="icon" />
            <h3>CO2 non sprecata</h3>
          </div>
          <p>CO2 emesso per produrre il cibo risparmiato. Valore calcolato facendo la media delle emissioni di CO2 per categoria alimentare secondo una tipica combinazione di beni recuperati</p>
          <div class="stat-value">3.81 Ton</div>
        </div>
        <!-- Box Distanza -->
        <div class="stat-box box-purple">
          <div class="box-title">
            <img src="/btf-databytes/icone/Ai/consegne.png" alt="Icona consegne" class="icon" />
            <h3>Distanza percorsa</h3>
          </div>
          <p>Distanza percorsa per recuperare la merce. Basato su 414 viaggi di andata e ritorno, di cui 26 esclusi perche non abbiamo potuto calcolare la distanza (circa 6%).</p>
          <div class="stat-value">6060 Km</div>
        </div>
        <!-- Box Prodotti -->
        <div class="stat-box box-yellow">
          <div class="box-title">
            <img src="/btf-databytes/icone/Ai/food.png" alt="Icona food" class="icon" />
            <h3>Prodotti alimentari</h3>
          </div>
          <p>Peso del cibo recuperato. Numero basato su merci pesate direttamente o il cui peso potrebbe essere stimato e classificato come cibo. Questo valore potrebbe essere inferiore al peso totale delle merci recuperate.</p>
          <div class="stat-value">2.38 Ton</div>
        </div>
        <!-- Box Acqua -->
        <div class="stat-box box-blue">
          <div class="box-title">
            <img src="/btf-databytes/icone/Ai/acqua.png" alt="Icona acqua" class="icon" />
            <h3>Acqua</h3>
          </div>
          <p>Quantità di acqua necessaria per produrre il cibo risparmiato. Valore calcolato facendo la media dell'impronta idrica per categoria alimentare secondo una tipica combinazione di beni recuperati.</p>
          <div class="stat-value">2.58 ML</div>
        </div>
      </div>
    </section>

    <!-- Bottone Chat AI -->
    <button class="side-round-btn" id="sideRoundBtn">
      <img src="/btf-databytes/icone/Ai/chat.png" alt="Chat Bot Icona" style="width: 30px; height: 30px;" />
    </button>
    <!-- Sidebar chat -->
    <div class="chat-sidebar" id="chatSidebar">
      <div class="chat-header">
        <h2>BTF Ai</h2>
        <button class="close-chat" id="closeChatBtn">&times;</button>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="message bot-message">
          <p>Ciao, sono BTF Ai  pronta a fornirti metriche e dati specifici basati sui dati raccolti fino ad oggi. Chidimi qualsiasi cosa...</p>
        </div>
      </div>
      <div class="chat-footer">
        <input type="text" class="chat-input" id="chatInput" placeholder="Scrivi il messaggio...">
        <button class="chat-send-btn" id="chatSendBtn">Invia</button>
      </div>
    </div>
  </main>

  <!-- DUE GRAFICI: CIAMBELLA E LINEE -->
  <div class="charts-container" id="chartSection">
    <div class="chart-wrapper">
      <canvas id="myChart"></canvas>
    </div>
    <div class="chart-wrapper">
      <canvas id="myChart2"></canvas>
    </div>
  </div>

<script>
const mensaCategoryData = {
  "Povo_1": {
    "Primi":   [10, 5, 15,  3, 12,  8,  9, 20, 22, 12,  6, 14],
    "Secondi": [ 3, 7, 12, 10, 15, 14, 20,  2, 11,  9, 22, 19],
    "Contorni":[ 4, 2,  8,  6,  1, 18, 16,  9,  7, 10,  5,  3],
    "Insalata":[ 8, 9, 10,  2, 13,  5,  0, 12,  6,  7, 15,  9],
    "Salumi":  [ 2, 6,  0, 15,  4,  1, 18,  5, 16,  1, 10, 22],
    "Pane":    [ 5, 3,  2, 11, 17,  6,  9,  8, 14, 25,  3,  7],
    "Varie":   [ 0, 2,  5,  1,  9, 12,  8, 13,  5,  4,  2,  3]
  },
  "Povo_2": {
    "Primi":   [ 7, 11,  5,  6, 15,  9,  3,  2, 21, 10,  8, 12],
    "Secondi": [15,  2,  6, 20,  1, 22, 10,  4,  8, 16, 14,  0],
    "Contorni":[ 3,  9, 18,  4,  7, 10, 12,  0,  6,  3, 25,  1],
    "Insalata":[ 9, 10,  2,  2,  3, 19,  1, 15,  5,  5, 10,  7],
    "Salumi":  [ 6,  1,  5, 12,  8,  9,  4,  6,  2, 13,  0, 16],
    "Pane":    [10,  4, 14,  6,  7,  2, 22,  8, 12,  9, 18, 20],
    "Varie":   [ 1,  2,  0, 16, 13, 14,  2,  7,  4, 12,  1, 22]
  },
  "BLM-ADIGE_SALA": {
    "Primi":   [ 5,  2,  9, 10, 15,  6, 14, 22,  5,  4,  3, 12],
    "Secondi": [10, 14,  7,  5,  1, 11, 19,  9, 16,  2, 17,  0],
    "Contorni":[ 0,  5,  1, 19, 20,  2,  8, 12, 10,  3, 15,  7],
    "Insalata":[ 9, 15, 22,  2,  7,  1,  3,  4,  8, 18, 10,  2],
    "Salumi":  [ 6,  6, 20,  5, 11, 15,  5,  5,  2,  9, 18,  3],
    "Pane":    [ 4,  1,  2,  7, 12, 14, 18,  3, 17,  6,  1,  7],
    "Varie":   [ 2,  8,  3, 10,  5,  6, 12,  3, 14,  0,  8, 10]
  }
};
const allMonths = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];

function calcolaRangeMesi(dataInizioStr, dataFineStr){
  if(!dataInizioStr || !dataFineStr) return { fromIndex:0, toIndex:11 };
  const startD = new Date(dataInizioStr);
  const endD   = new Date(dataFineStr);
  if(isNaN(startD) || isNaN(endD) || startD> endD) {
    return { fromIndex:0, toIndex:11 };
  }
  let si = startD.getMonth();
  let ei = endD.getMonth();
  if(si> ei) [si, ei] = [ei, si];
  return { fromIndex: si, toIndex: ei };
}

function calcolaSommaCategorie(mensa, fromIndex, toIndex){
  const categories = ["Primi","Secondi","Contorni","Insalata","Salumi","Pane","Varie"];
  if(!mensaCategoryData[mensa]) {
    // se la mensa non esiste, array di 0
    return categories.map(()=>0);
  }
  return categories.map(cat=>{
    const arrValori = mensaCategoryData[mensa][cat];
    // subset da fromIndex..toIndex
    const subset = arrValori.slice(fromIndex, toIndex+1);
    return subset.reduce((acc, val)=> acc+ val, 0);
  });
}

function calcolaSommaMensile(mensa, fromIndex, toIndex){
  if(!mensaCategoryData[mensa]) {
    // array di 0 per ogni mese
    return Array(toIndex- fromIndex+1).fill(0);
  }
  const categories = ["Primi","Secondi","Contorni","Insalata","Salumi","Pane","Varie"];
  const results = [];

  for(let m= fromIndex; m<= toIndex; m++){
    let sumMonth = 0;
    for(const cat of categories){
      sumMonth += mensaCategoryData[mensa][cat][m];
    }
    results.push(sumMonth);
  }
  return results;
}

let chartDonut  = null; // ciambella
let chartLine   = null; // line

function creaOaggiornaCiambella(labelsCat, dataCat, mensaLabel){
  if(chartDonut) chartDonut.destroy();
  const ctx1 = document.getElementById("myChart").getContext("2d");
  chartDonut = new Chart(ctx1, {
    type: 'doughnut',
    data: {
      labels: labelsCat,   // "Primi","Secondi",...
      datasets: [{
        label: mensaLabel,
        data: dataCat,
        backgroundColor: [
          'rgb(255,99,132)',
          'rgb(255,159,64)',
          'rgb(255,205,86)',
          'rgb(75,192,192)',
          'rgb(54,162,235)',
          'rgb(153,102,255)',
          'rgb(201,203,207)'
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: 'Piatti raccolti' }
      }
    }
  });
}

function creaOaggiornaLine(labelsMesi, dataMesi, mensaLabel){
  if(chartLine) chartLine.destroy();
  const ctx2 = document.getElementById("myChart2").getContext("2d");
  chartLine = new Chart(ctx2, {
    type: 'line',
    data: {
      labels: labelsMesi,
      datasets: [{
        label: mensaLabel,
        data: dataMesi,
        borderColor: 'rgba(244,161,8,1)',
        backgroundColor: 'rgba(244,161,8,0.3)',
        pointStyle: 'rectRot',
        pointRadius: 7
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'KG raccolti mensilmente' }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

// ============ MAIN ============
window.addEventListener('DOMContentLoaded', ()=>{
  // Inizializza i grafici con "nessuna mensa" => array di 0
  creaOaggiornaCiambella(["Primi","Secondi","Contorni","Insalata","Salumi","Pane","Varie"], 
                         [0,0,0,0,0,0,0], 
                         "Nessuna mensa");
  creaOaggiornaLine(allMonths, Array(12).fill(0), "Nessuna mensa");

  // Al click su "Applica filtri"
  document.getElementById("applyFiltersBtn").addEventListener("click", e=>{
    e.preventDefault();
    const mensa = document.getElementById("mensaSelect").value || "";
    const fromD = document.getElementById("timeframeStart").value;
    const toD   = document.getElementById("timeframeEnd").value;
    const { fromIndex, toIndex } = calcolaRangeMesi(fromD, toD);

    // 1) Calcola ciambella 
    const catLabels = ["Primi","Secondi","Contorni","Insalata","Salumi","Pane","Varie"];
    if(!mensa){
      // Se nessuna mensa
      creaOaggiornaCiambella(catLabels, [0,0,0,0,0,0,0], "Nessuna mensa");
      creaOaggiornaLine(allMonths.slice(fromIndex, toIndex+1), Array(toIndex-fromIndex+1).fill(0), "Nessuna mensa");
      return;
    }
    const catSums = calcolaSommaCategorie(mensa, fromIndex, toIndex);
    // 2) Calcola line 
    const monthlySums = calcolaSommaMensile(mensa, fromIndex, toIndex);
    const labelMesi = allMonths.slice(fromIndex, toIndex+1);

    // Rigenera i grafici
    creaOaggiornaCiambella(catLabels, catSums, mensa);
    creaOaggiornaLine(labelMesi, monthlySums, mensa);
  });
});
</script>
</body>
</html>
